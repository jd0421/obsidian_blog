---
{"dg-publish":true,"permalink":"/public/course/course-datarian//","tags":["Retention","date_add","date_sub"],"created":"2025-08-27T15:38:31.440+09:00","updated":"2025-08-29T16:08:46.218+09:00"}
---

https://solvesql.com/problems/monthly-classic-retention/

고객의 첫 구매일자를 구한다
고객의 첫 구매일자를 집게 기준으로 나타내는 year-month 형식으로 수정
주문 이력이 있는 고객 대상으로만 리텐션 구하기 위해 inner join 으로 연결
위 사항을 cte 테이블로 구현
cte 테이블에서 첫 구매일자 (year-month 형식의) 를 기준으로 interval 1 month 단위로 집계를 구한다

- reference
	- date_add, date_sub https://extbrain.tistory.com/58

```mysql
with step1 as (

  SELECT

    customer_stats.customer_id

    , customer_stats.first_order_date

    , DATE_FORMAT(customer_stats.first_order_date, '%Y-%m-01') AS first_order_month

    , customer_stats.last_order_date

    , DATE_FORMAT(customer_stats.last_order_date, '%Y-%m-01') AS last_order_month

    , DATE_FORMAT(records.order_date,'%Y-%m-01') AS order_month

  FROM customer_stats

    INNER JOIN records ON customer_stats.customer_id = records.customer_id

)

  

SELECT

  first_order_month

  , count(distinct customer_id) as `month0`

  , count(distinct case when date_add(first_order_month, interval 1 month) = order_month then customer_id else null end) as `month1`

  , count(distinct case when date_add(first_order_month, interval 2 month) = order_month then customer_id else null end) as `month2`

  , count(distinct case when date_add(first_order_month, interval 3 month) = order_month then customer_id else null end) as `month3`

  , count(distinct case when date_add(first_order_month, interval 4 month) = order_month then customer_id else null end) as `month4`

  , count(distinct case when date_add(first_order_month, interval 5 month) = order_month then customer_id else null end) as `month5`

  , count(distinct case when date_add(first_order_month, interval 6 month) = order_month then customer_id else null end) as `month6`

  , count(distinct case when date_add(first_order_month, interval 7 month) = order_month then customer_id else null end) as `month7`

  , count(distinct case when date_add(first_order_month, interval 8 month) = order_month then customer_id else null end) as `month8`

  , count(distinct case when date_add(first_order_month, interval 9 month) = order_month then customer_id else null end) as `month9`

  , count(distinct case when date_add(first_order_month, interval 10 month) = order_month then customer_id else null end) as `month10`

  , count(distinct case when date_add(first_order_month, interval 11 month) = order_month then customer_id else null end) as `month11`

  

from

  step1

  

group by

  1

  
  

-- WITH records_preprocesssed AS (

--   SELECT

--   customer_stats.customer_id

--   , customer_stats.first_order_date

--   , DATE_FORMAT(customer_stats.first_order_date, '%Y-%m-01') AS first_order_month

--   , customer_stats.last_order_date

--   , DATE_FORMAT(customer_stats.last_order_date, '%Y-%m-01') AS last_order_month

--   , DATE_FORMAT(records.order_date,'%Y-%m-01') AS order_month

-- FROM customer_stats

--   INNER JOIN records ON customer_stats.customer_id = records.customer_id

  

-- )

  

-- SELECT

--   first_order_month

--   , COUNT(DISTINCT customer_id) AS 'month0'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 1 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month1'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 2 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month2'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 3 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month3'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 4 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month4'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 5 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month5'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 6 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month6'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 7 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month7'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 8 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month8'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 9 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month9'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 10 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month10'

--   , COUNT(DISTINCT CASE WHEN DATE_ADD(first_order_month, INTERVAL 11 MONTH) = order_month THEN customer_id ELSE NULL END) AS 'month11'

-- FROM

--   records_preprocesssed

  

-- GROUP BY

--   first_order_month

  

-- ;
```